# Generated by Django 3.2.10 on 2022-04-05 14:01

from django.db import migrations
from graphql.error.base import GraphQLError
from saleor.graphql.core.utils import from_global_id_or_error
from saleor.product.models import Product

from vendor.models import Vendor


def migrate_old_vendors(apps, schema_editor):
    for product in Product.objects.all():
        vendor_id = product.get_value_from_metadata("vendor")
        if vendor_id:
            try:
                _, pk = from_global_id_or_error(vendor_id, "Vendor")
                vendor = Vendor.objects.filter(pk=pk).first()
            except GraphQLError:
                vendor = Vendor.objects.filter(brand_name=vendor_id).first()
            if vendor:
                product.vendor_set.add(vendor)


class Migration(migrations.Migration):
    dependencies = [
        ("vendor", "0023_auto_20220327_1110"),
    ]

    operations = [
        migrations.RunPython(migrate_old_vendors, migrations.RunPython.noop),
    ]
